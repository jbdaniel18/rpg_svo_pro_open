<?xml version="1.0"?>
# Instructions:
# - Most of the time you will just need to change the basic parameters.
# - The parameters in this file are set for the resolution of 752x480.
#   If you use a different resolution, change the parameters for
#   each module according to the comments.

############################
##### Basic parameters #####
############################

# Automatic initialisation
automatic_reinitialization: True

# Pipeline type
pipeline_is_stereo: False

# Feature and keyframe number
# To run faster, you can decrease `max_fts` and `max_n_kfs`, for example:
# max_fts: 120
# max_n_kfs: 5
max_fts: 180
max_n_kfs: 30

# Map scale when initialized (not used for stereo)
# Increase if the initial scene depth is larger
map_scale: 1.5

# Initial rotation
T_world_imuinit/qx: 0
T_world_imuinit/qy: 0
T_world_imuinit/qz: 0
T_world_imuinit/qw: 1

# Keyframe selection
kfselect_criterion: FORWARD    # alterntive: DOWNLOOKING
# The following kfselect_* ONLY affects FORWARD
# If the number of features: >upper, no keyframe; <lower, take keyframe
kfselect_numkfs_upper_thresh: 120
kfselect_numkfs_lower_thresh: 70
# If the current frame is within the following range of any visible keyframes,
# do not take a new keyframe.
# You can lower these values for more keyframes
kfselect_min_dist_metric: 0.1
kfselect_min_angle: 20
# If the median disparity from the last keyframe is smaller,
# do not take a new keyframe
# You can lower this value for more keyframes
kfselect_min_disparity: 40
# When taking a new keyframe,
# we can already update the newly initialized seeds with old keyframes.
# This is important for forward looking case.
update_seeds_with_old_keyframes: True

kfselect_backend_max_time_sec: -1.0
kfselect_min_num_frames_between_kfs: 1

# Default affine compensation parameters
# Most of the parameters are set to false for the consideration of processing time.
# If you observe bad tracking because of light/expousre change,
# enable the following parameters.
img_align_est_illumination_gain: True
img_align_est_illumination_offset: True
depth_filter_affine_est_offset: True
depth_filter_affine_est_gain: True
reprojector_affine_est_offset: True
reprojector_affine_est_gain: True

########################################
###### Tuning for each module ##########
########################################
# Initialization
# For a higher resolution, increase the value accordingly.
init_min_disparity: 30

# Feature Detection
grid_size: 30 # Larger for larger images, for every cell you have max one feature.
n_pyr_levels: 3 # Increase for larger images (image align max minus one)
detector_threshold_primary: 10 # Fast detector threshold
detector_threshold_secondary: 200 # Edgelet detector threshold
detector_threshold_shitomasi: 50 # Map Point detector threshold

# Image Alignment
img_align_max_level: 4 # Increase this level by one if the image is double the width and height (752x480).
img_align_min_level: 2

# Reprojection
use_async_reprojectors: False # For stereo, change it to True for multithreading.
reprojector_max_n_kfs: 5 # Local map size. Larger is computationally more intensive. More reduces drift.
scan_epi_unit_sphere: False # for wide angle lens, set it to True.
reproject_unconverged_seeds: True
max_unconverged_seeds_ratio: 0.2
reprojector_max_fixed_landmarks: 100
reprojector_max_n_global_kfs: 30
reprojector_fixed_lm_grid_size: 50

# Pose Optimization
poseoptim_thresh: 2.0 # Reprojection outlier threshold (px), should be larger for larger images.
poseoptim_using_unit_sphere: False # For wide angle lens, set it to True

# Depth Filter
# How many times does the covariance need to decrease until a seed is considered converged.
# Increase to get more accurate points
seed_convergence_sigma2_thresh: 200
mappoint_convergence_sigma2_thresh: 500
relocalization_max_trials: 5

# IMU
# Normally the prior should be 0 if not using IMU.
use_imu: False
poseoptim_prior_lambda: 0.0 # Gyroscope prior in pose optimization
img_align_prior_lambda_rot: 0.0 # Gyroscope prior in sparse image alignment
img_align_prior_lambda_trans: 0.0 # Constant velocity assumption prior in sparse image alignment

# Dense input
publish_every_nth_dense_input: 5

# Visualization
publish_marker_scale: 0.5
publish_active_kfs: True

# Disable ceres backend
use_ceres_backend: false

# Handle tracking loss
global_map_timeout_sec: 3.0

##############################
##### Loop Closing parameters #####
##############################
# Flag to enable/disable loop closing
runlc: True
# Name of the file which stores the BOW vocabulary #
voc_name: voc_GEN_8X4.yml.gz
# Data Extraction Threshold #
alpha: 0.8
# Loop Closure Detection Threshold #
beta: 0.8
# Number of past frames to ignore when looking for loop closures #
frames_to_ignore: 20
# Approach to use for scale retrieval in monocular case #
# 1. Common Landmarks Method #
# 2. Mixed Keypoints Method #
scale_retrieval_approach: None
# Bag of Words match threshold #
bow_thresh: 0.65
# Geometric Verification Threshold i.e minimum ratio of inliers #
gv_3d_inlier_thresh: 0.4
# Minimum 3d matches needed for good loop closing #
min_num_3d: 10
# Distance threshold when matching ORB features #
orb_dist_thresh: 48
# Minimum ratio of matches in geometric verification #
gv_2d_match_thresh: 0.2
# use opengv for ransac during geometric verification
use_opengv: true
# Enable this option to log images and inlier matches between loop closure frames */
enable_image_logging: false
# Path to the folder where images will be locked. Make sure folder is already created */
image_log_base_path: /tmp/loopclosure_log/
# For Loop Correction
ransac3d_inlier_percent: 60

proximity_dist_ratio: 0.01
proximity_offset: 1.0

global_map_type: ExternalGlobalMap

force_correction_dist_thresh_meter: 0.1

##############################
# Global map
##############################
#depth_filter_extra_map_points: True
#max_map_fts: 200
#reprojector_use_kfs_from_global_map: True
#refine_extrinsics: True

#use_global_map: True
## initialization
#gm_init_min_frame_opt: 15
#gm_init_min_lm_obs_frame: 8
#gm_use_smart_factor: False
#gm_debug_fix_all_poses: False
#gm_print_stdcout: False
#gm_use_imu: True
#gm_use_thread: True
#gm_verbose: False
#gm_only_add_every_n: -1
#gm_optimize_every_n: -1
#gm_point_stable_thresh_meter: -1.0
#gm_inc_version_stable_ratio: -1.0

## reobsrevation
#gm_add_reprojected_fixed_landmark: true
#gm_max_reprojected_fixed_landmark_each_frame: 20
#gm_ignore_redundant_landmarks: false
#gm_ignore_grid_size: 25
#gm_fix_lm_reobs_threshold: -1

## point adding and fixation
#gm_min_num_obs: 3
#gm_pt_cond_thresh: -1
#gm_pt_sigma_thresh: 0.5
#gm_max_point_age: 10
#gm_min_parallax_deg: 5.0
#gm_add_range_prior_to_good_pt: True
#gm_use_edgelet: False
#gm_use_map_point: True
#gm_map_point_min_obs: 5

## frame: fix with respect to previous one
#gm_use_relative_pose_fixation: True
#gm_relative_prior_with_imu_min_time_sec: -1.0
#gm_frame_fixation_release_check: False
#gm_relative_min_common_obs: 10
#gm_relative_release_min_common_obs: 40
#gm_relative_pos_sigma_meter: 0.1
#gm_relative_rot_sigma_deg: 5.0

## query
#gm_query_frame_min_3d_points: 20

## gtsam related
#ba_use_bearing_factor: True
#ba_pos_sigma_meter: 0.000001
#ba_rot_sigma_degree: 0.000001
#ba_init_roll_pitch_sigma_degree: 45.0
#ba_point_sigma_meter: 0.0001

#ba_max_iterations_per_update: 10
#ba_min_iterations_per_update: 3
#ba_max_time_sec_per_update: 5.0

#ba_use_robust_px_noise: True
#isam_relinearize_thresh: 0.01
#isam_relinearize_skip: 5
#isam_wildfire_thresh: 0.001
#isam_optimization_method: GaussNewton
#ba_smart_reproj_outlier_thresh_px: 15.0
